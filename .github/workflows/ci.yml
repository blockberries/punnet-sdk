# .github/workflows/ci.yml
#
# Main CI pipeline for punnet-sdk. Runs on every PR and push to main.
#
# Maintainer: The Glue
# Last major update: 2026-02 (Go 1.25.6 + golangci-lint v2.8.0)
#
# If this breaks at 2 AM, check:
# 1. GitHub Actions status page
# 2. Go module proxy issues
# 3. Recent dependency updates

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

env:
  GO_VERSION: '1.25.6'

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage.out

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v2.8.0  # Pinned version - supports Go 1.25.x

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build
        run: go build ./...

  benchmark:
    name: Benchmark
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: Run benchmarks on PR branch
        run: |
          go test -bench=. -benchmem -count=5 -benchtime=1s ./... 2>/dev/null | tee pr-bench.txt

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          clean: false

      - name: Run benchmarks on base branch
        run: |
          go test -bench=. -benchmem -count=5 -benchtime=1s ./... 2>/dev/null | tee base-bench.txt

      - name: Checkout PR branch again for comparison
        uses: actions/checkout@v4
        with:
          clean: false

      - name: Compare benchmarks
        id: benchstat
        run: |
          echo "## Benchmark Comparison" > bench-report.md
          echo "" >> bench-report.md
          echo "Comparing PR branch against \`${{ github.base_ref }}\`" >> bench-report.md
          echo "" >> bench-report.md
          echo "\`\`\`" >> bench-report.md
          benchstat base-bench.txt pr-bench.txt >> bench-report.md 2>&1 || true
          echo "\`\`\`" >> bench-report.md
          echo "" >> bench-report.md

          # Check for regressions (>10% slower)
          # benchstat outputs lines like: "name  old time/op  new time/op  delta"
          # We look for lines with +XX% where XX > threshold
          THRESHOLD=10
          REGRESSIONS=$(benchstat base-bench.txt pr-bench.txt 2>/dev/null | grep -E '\+[0-9]+\.[0-9]+%' | awk -F'+' '{
            for(i=2;i<=NF;i++) {
              if(match($i, /^[0-9]+\.[0-9]+%/)) {
                pct = substr($i, 1, RLENGTH-1)
                if(pct > '$THRESHOLD') {
                  print $0
                  exit 0
                }
              }
            }
          }' || true)

          if [ -n "$REGRESSIONS" ]; then
            echo "has_regression=true" >> $GITHUB_OUTPUT
            echo "" >> bench-report.md
            echo "### Potential Regressions Detected" >> bench-report.md
            echo "" >> bench-report.md
            echo "The following benchmarks show >$THRESHOLD% regression:" >> bench-report.md
            echo "" >> bench-report.md
            echo "\`\`\`" >> bench-report.md
            echo "$REGRESSIONS" >> bench-report.md
            echo "\`\`\`" >> bench-report.md
          else
            echo "has_regression=false" >> $GITHUB_OUTPUT
            echo "" >> bench-report.md
            echo "No significant regressions detected (threshold: $THRESHOLD%)" >> bench-report.md
          fi

          cat bench-report.md

      - name: Post benchmark results as PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('bench-report.md', 'utf8');

            // Find existing benchmark comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## Benchmark Comparison')
            );

            const body = report + '\n\n---\n*Updated by CI on ' + new Date().toISOString() + '*';

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Check for regressions
        if: steps.benchstat.outputs.has_regression == 'true'
        run: |
          echo "::warning::Performance regression detected! See benchmark comparison above."
          echo "To override this check, add the 'skip-benchmark-check' label to the PR."
          # Don't fail the build - just warn. Use the label check below for enforcement.

      - name: Fail on regression (unless skipped)
        if: steps.benchstat.outputs.has_regression == 'true' && !contains(github.event.pull_request.labels.*.name, 'skip-benchmark-check')
        run: |
          echo "::error::Benchmark regression detected and 'skip-benchmark-check' label not present."
          echo "If this regression is acceptable, add the 'skip-benchmark-check' label to the PR."
          exit 1

  benchmark-baseline:
    name: Update Benchmark Baseline
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run benchmarks
        run: |
          go test -bench=. -benchmem -count=5 -benchtime=1s ./... 2>/dev/null | tee benchmarks/baseline.txt

      - name: Upload baseline
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-baseline
          path: benchmarks/baseline.txt
          retention-days: 90
